{{ template "header.html" . }}

<div class="flex justify-between items-center mb-4">
    <h1>Analytics</h1>
    <a href="/" class="btn btn-secondary">Back to Home</a>
</div>

<div class="card">
    <div class="card-header">Engagement Over Time</div>
    <div style="position: relative; height: 60vh; min-height: 400px; width: 100%;">
        <canvas id="engagementChart"></canvas>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        fetch('/stats')
            .then(response => response.json())
            .then(data => {
                if (!data || data.length === 0) {
                    return;
                }

                const ctx = document.getElementById('engagementChart').getContext('2d');

                const datasets = [];
                const allDates = new Set();

                Chart.defaults.color = '#a0a0a0';
                Chart.defaults.borderColor = '#333';

                data.forEach(source => {
                    const points = source.points || [];
                    const dataPoints = points.map(p => {
                        const dateStr = p.date.split('T')[0];
                        allDates.add(dateStr);
                        return {
                            x: dateStr,
                            y: p.likes + p.reposts
                        };
                    });

                    let hash = 0;
                    const str = source.network + source.username;
                    for (let i = 0; i < str.length; i++) {
                        hash = str.charCodeAt(i) + ((hash << 5) - hash);
                    }
                    const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
                    const color = '#' + "00000".substring(0, 6 - c.length) + c;

                    datasets.push({
                        label: `${source.network} (${source.username})`,
                        data: dataPoints,
                        borderColor: color,
                        backgroundColor: color + '20',
                        fill: false,
                        tension: 0.3,
                        borderWidth: 2,
                        pointRadius: 3
                    });
                });

                const sortedDates = Array.from(allDates).sort();

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: sortedDates,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        scales: {
                            x: {
                                type: 'category',
                                grid: { color: 'rgba(255, 255, 255, 0.05)' }
                            },
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Total Engagement' },
                                grid: { color: 'rgba(255, 255, 255, 0.05)' }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { padding: 20, usePointStyle: true }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(20, 20, 30, 0.9)',
                                titleColor: '#fff',
                                bodyColor: '#ccc',
                                padding: 10,
                                cornerRadius: 8,
                                displayColors: true
                            }
                        }
                    }
                });
            })
            .catch(err => console.error("Error fetching stats:", err));
    });
</script>

{{ template "footer.html" . }}