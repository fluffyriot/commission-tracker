{{ template "header.html" . }}

<div class="flex justify-between items-center mb-6">
    <div>
        <h1>Analytics</h1>
    </div>
</div>

<div class="tabs mb-6">
    <button class="tab-btn active" data-tab="content">Content</button>
    <button class="tab-btn" data-tab="engagement">Engagement</button>
    <button class="tab-btn" data-tab="timing">Timing</button>
    <button class="tab-btn" data-tab="website">Website</button>
</div>

<div id="content-tab" class="tab-content active">
    <div class="grid-dashboard">
        <div class="card col-span-full md:col-span-2">
            <div class="card-header">Word Cloud (Top Keywords)</div>
            <div class="chart-container" id="word-cloud-container" style="overflow: hidden;">
                <canvas id="wordCloudCanvas" style="width: 100%; height: 100%;"></canvas>
            </div>
        </div>

        <div class="card col-span-full">
            <div class="card-header">Top Hashtags Performance</div>
            <div class="chart-container" style="overflow: hidden;">
                <canvas id="hashtagsChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div id="engagement-tab" class="tab-content hidden">
    <div class="grid-dashboard">
        <div class="card">
            <div class="card-header">Content Type Performance</div>
            <div class="chart-container">
                <canvas id="postTypesChart"></canvas>
            </div>
        </div>
        <div class="card">
            <div class="card-header">Network Efficiency</div>
            <div class="chart-container">
                <canvas id="networkEfficiencyChart"></canvas>
            </div>
        </div>
        <div class="card col-span-full">
            <div class="card-header">Top Mentions Performance</div>
            <div class="chart-container">
                <canvas id="mentionsChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div id="timing-tab" class="tab-content hidden">
    <div class="card">
        <div class="card-header">Best Time to Post (Avg Likes)</div>
        <div class="relative w-full overflow-auto">
            <div id="heatmap-container" class="min-w-[600px] h-[500px]"></div>
        </div>
        <div class="text-sm text-muted mt-2 text-center">Day of Week x Hour of Day (Darker = Higher Engagement)</div>
    </div>

    <div class="card col-span-full mt-6">
        <div class="card-header">Posting Consistency (Last 365 Days)</div>
        <div class="relative w-full overflow-auto">
            <div id="calendar-heatmap-container" class="min-w-[800px] pb-4"></div>
        </div>
    </div>
</div>

<div id="website-tab" class="tab-content hidden">
    <div class="grid-dashboard">
        <div class="card col-span-full">
            <div class="card-header">Site Stats Over Time</div>
            <div class="chart-container">
                <canvas id="siteStatsChart"></canvas>
            </div>
        </div>
        <div class="card col-span-full">
            <div class="card-header">Top Viewed Pages</div>
            <div class="chart-container" style="height: 500px;">
                <canvas id="topPagesChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.2.2/wordcloud2.min.js"
    integrity="sha384-EuMVig/i0NsY8k6u37PJ4vzAbjRrxUknKzGF1JX32n8tasgHVvG817xx3+6WatZe"
    crossorigin="anonymous"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const colors = {
            primary: '#9167e4',
            primaryLight: '#b39ddb',
            primaryDark: '#5e35b1',
            accent: '#d1c4e9',
            text: '#a0a0a0',
            grid: 'rgba(255,255,255,0.05)',
            highContrast: ['#9167e4', '#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#ec4899', '#6366f1', '#8b5cf6']
        };

        Chart.defaults.color = colors.text;
        Chart.defaults.borderColor = colors.grid;
        Chart.defaults.font.family = "'Inter', system-ui, sans-serif";

        const loadedTabs = new Set();

        function loadTab(tabName) {
            if (loadedTabs.has(tabName)) return;
            loadedTabs.add(tabName);

            switch (tabName) {
                case 'content':
                    loadWordCloud();
                    loadHashtags();
                    break;
                case 'engagement':
                    loadPostTypes();
                    loadNetworkEfficiency();
                    loadMentions();
                    break;
                case 'timing':
                    loadTiming();
                    loadPostingConsistency();
                    break;
                case 'website':
                    loadWebsiteStats();
                    break;
            }
        }

        initTabManagement('content', loadTab);

        function createChart(ctxId, type, data, options = {}) {
            const ctx = document.getElementById(ctxId).getContext('2d');
            return new Chart(ctx, {
                type: type,
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    ...options
                }
            });
        }

        function loadWordCloud() {
            fetch('/analytics/data/wordcloud')
                .then(res => res.json())
                .then(data => {
                    if (!data || data.length === 0) return;
                    const canvas = document.getElementById('wordCloudCanvas');
                    const container = document.getElementById('word-cloud-container');

                    canvas.width = container.clientWidth;
                    canvas.height = container.clientHeight;

                    const list = data.map(item => [item.word, item.count * 5]);
                    WordCloud(canvas, {
                        list: list,
                        gridSize: Math.max(4, Math.floor(container.clientWidth / 100)),
                        weightFactor: size => Math.min(size * (container.clientWidth / 80), 60),
                        fontFamily: 'Inter, system-ui, sans-serif',
                        color: (word, weight) => (weight > 20) ? '#f0f0f0' : colors.text,
                        rotateRatio: 0.5,
                        backgroundColor: 'transparent',
                        shrinkToFit: true
                    });
                })
                .catch(err => console.error(err));
        }

        function loadHashtags() {
            fetch('/analytics/data/hashtags')
                .then(res => res.json())
                .then(data => {
                    if (!data) return;
                    createChart('hashtagsChart', 'bar', {
                        labels: data.map(d => d.tag),
                        datasets: [{
                            label: 'Usage Count',
                            data: data.map(d => d.usage_count),
                            backgroundColor: colors.primary,
                            yAxisID: 'y'
                        }, {
                            label: 'Avg Likes',
                            data: data.map(d => d.avg_likes),
                            backgroundColor: colors.primaryLight,
                            yAxisID: 'y1'
                        }]
                    }, {
                        scales: {
                            y: { position: 'left', title: { display: true, text: 'Posts Count' } },
                            y1: { position: 'right', title: { display: true, text: 'Avg Likes' }, grid: { drawOnChartArea: false } }
                        }
                    });
                });
        }

        function loadMentions() {
            fetch('/analytics/data/mentions')
                .then(res => res.json())
                .then(data => {
                    if (!data) return;
                    createChart('mentionsChart', 'bar', {
                        labels: data.map(d => d.mention),
                        datasets: [{
                            label: 'Avg Likes',
                            data: data.map(d => d.avg_likes),
                            backgroundColor: colors.primary,
                            yAxisID: 'y',
                            order: 2
                        }, {
                            label: 'Usage Count',
                            data: data.map(d => d.usage_count),
                            borderColor: colors.accent,
                            backgroundColor: colors.accent,
                            type: 'line',
                            yAxisID: 'y1',
                            order: 1
                        }]
                    }, {
                        scales: {
                            y: { position: 'left', title: { display: true, text: 'Avg Likes' } },
                            y1: { position: 'right', title: { display: true, text: 'Usage Count' }, grid: { drawOnChartArea: false } }
                        }
                    });
                });
        }

        function loadPostTypes() {
            fetch('/analytics/data/types')
                .then(res => res.json())
                .then(data => {
                    if (!data) return;
                    createChart('postTypesChart', 'doughnut', {
                        labels: data.map(d => d.post_type),
                        datasets: [{
                            data: data.map(d => d.avg_likes),
                            backgroundColor: colors.highContrast
                        }]
                    }, {
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: { padding: 20, usePointStyle: true }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const count = data[context.dataIndex].post_count;
                                        return ` ${label}: ${value} avg likes (${count} posts)`;
                                    }
                                }
                            }
                        },
                        layout: { padding: 20 }
                    });
                });
        }

        function loadNetworkEfficiency() {
            fetch('/analytics/data/networks')
                .then(res => res.json())
                .then(data => {
                    if (!data) return;
                    createChart('networkEfficiencyChart', 'bar', {
                        labels: data.map(d => d.network),
                        datasets: [{
                            label: 'Avg Likes per Post',
                            data: data.map(d => d.avg_likes),
                            backgroundColor: colors.primary,
                            yAxisID: 'y',
                            order: 2
                        }, {
                            label: 'Post Count',
                            data: data.map(d => d.post_count),
                            borderColor: colors.accent,
                            backgroundColor: colors.accent,
                            type: 'line',
                            yAxisID: 'y1',
                            order: 1
                        }]
                    }, {
                        indexAxis: 'x',
                        scales: {
                            y: { position: 'left', title: { display: true, text: 'Avg Likes' } },
                            y1: { position: 'right', title: { display: true, text: 'Post Count' }, grid: { drawOnChartArea: false } }
                        }
                    });
                });
        }

        function loadTiming() {
            fetch('/analytics/data/time')
                .then(res => res.json())
                .then(data => {
                    if (!data) return;
                    renderHeatmap(data);
                });
        }

        let tooltipEl = null;

        function getTooltip() {
            if (!tooltipEl) {
                tooltipEl = document.createElement('div');
                tooltipEl.className = 'analytics-tooltip';
                document.body.appendChild(tooltipEl);
            }
            return tooltipEl;
        }

        function showTooltip(e, text) {
            const tip = getTooltip();
            tip.textContent = text;
            tip.style.display = 'block';
            tip.style.left = e.pageX + 'px';
            tip.style.top = e.pageY + 'px';
        }

        function hideTooltip() {
            const tip = getTooltip();
            tip.style.display = 'none';
        }

        function renderHeatmap(data) {
            const container = document.getElementById('heatmap-container');
            container.innerHTML = '';

            const mainContainer = document.createElement('div');
            mainContainer.className = 'calendar-heatmap-container';
            mainContainer.style.display = 'flex';
            mainContainer.style.flexDirection = 'column';
            mainContainer.style.gap = '5px';

            const headerRow = document.createElement('div');
            headerRow.style.display = 'flex';
            headerRow.style.marginLeft = '40px';

            for (let h = 0; h < 24; h++) {
                const el = document.createElement('div');
                el.className = 'heatmap-label';
                el.style.flex = '1';
                el.style.textAlign = 'center';
                el.textContent = h;
                headerRow.appendChild(el);
            }
            mainContainer.appendChild(headerRow);

            const gridBody = document.createElement('div');
            gridBody.style.display = 'flex';
            gridBody.style.flexDirection = 'column';
            gridBody.style.gap = '2px';

            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const maxVal = Math.max(...data.map(d => d.avg_likes));
            const dataMap = {};
            data.forEach(d => { dataMap[`${d.day_of_week}-${d.hour_of_day}`] = d.avg_likes; });

            for (let d = 0; d < 7; d++) {
                const row = document.createElement('div');
                row.style.display = 'flex';
                row.style.alignItems = 'center';
                row.style.gap = '2px';

                const label = document.createElement('div');
                label.className = 'heatmap-label';
                label.style.width = '40px';
                label.textContent = days[d];
                row.appendChild(label);

                for (let h = 0; h < 24; h++) {
                    const val = dataMap[`${d}-${h}`] || 0;
                    const cell = document.createElement('div');
                    cell.className = 'heatmap-cell';
                    cell.style.flex = '1';
                    cell.style.aspectRatio = '1';
                    cell.style.backgroundColor = 'rgba(255,255,255,0.02)';
                    cell.style.borderRadius = '2px';

                    if (val > 0) {
                        const intensity = maxVal > 0 ? (val / maxVal) : 0;
                        cell.style.backgroundColor = `rgba(145, 103, 228, ${intensity * 0.9 + 0.1})`;
                    }

                    cell.addEventListener('mousemove', (e) => showTooltip(e, `${days[d]} ${h}:00 - Avg Likes: ${Math.round(val)}`));
                    cell.addEventListener('mouseleave', hideTooltip);

                    row.appendChild(cell);
                }
                gridBody.appendChild(row);
            }
            mainContainer.appendChild(gridBody);
            container.appendChild(mainContainer);
        }

        function loadPostingConsistency() {
            fetch('/analytics/data/consistency')
                .then(res => res.json())
                .then(data => {
                    renderCalendarHeatmap(data || []);
                });
        }

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return weekNo;
        }

        function renderCalendarHeatmap(data) {
            const container = document.getElementById('calendar-heatmap-container');
            container.innerHTML = '';

            const weeklyData = Array.from({ length: 53 }, () => Array(7).fill(0));

            data.forEach(d => {
                const date = new Date(d.date_str);
                const weekNum = getWeekNumber(date);
                const dayOfWeek = date.getDay();

                if (weekNum >= 1 && weekNum <= 52) {
                    weeklyData[weekNum][dayOfWeek] += d.post_count;
                }
            });

            const mainContainer = document.createElement('div');
            mainContainer.className = 'calendar-heatmap-container';
            mainContainer.style.display = 'flex';
            mainContainer.style.flexDirection = 'column';
            mainContainer.style.gap = '5px';
            mainContainer.style.width = '100%';

            const monthRow = document.createElement('div');
            monthRow.style.display = 'flex';
            monthRow.style.position = 'relative';
            monthRow.style.height = '20px';
            monthRow.style.width = '100%';
            monthRow.style.paddingLeft = '40px';
            monthRow.style.overflow = 'hidden';
            monthRow.style.paddingRight = '20px';

            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            months.forEach((m, i) => {
                const label = document.createElement('div');
                label.className = 'heatmap-label';
                label.textContent = m;
                label.style.position = 'absolute';
                label.style.left = `calc(${(i / 12) * 100}% + 40px)`;
                label.style.whiteSpace = 'nowrap';
                monthRow.appendChild(label);
            });
            mainContainer.appendChild(monthRow);

            const gridBody = document.createElement('div');
            gridBody.style.display = 'flex';
            gridBody.style.flexDirection = 'column';
            gridBody.style.gap = '2px';

            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

            let maxVal = 1;
            for (let w = 1; w <= 52; w++) {
                for (let d = 0; d < 7; d++) {
                    maxVal = Math.max(maxVal, weeklyData[w][d]);
                }
            }

            for (let d = 0; d < 7; d++) {
                const row = document.createElement('div');
                row.style.display = 'flex';
                row.style.alignItems = 'center';
                row.style.gap = '2px';

                const label = document.createElement('div');
                label.className = 'heatmap-label';
                label.style.width = '40px';
                label.textContent = days[d];
                row.appendChild(label);

                for (let w = 1; w <= 52; w++) {
                    const count = weeklyData[w][d];
                    const cell = document.createElement('div');
                    cell.className = 'heatmap-cell';
                    cell.style.flex = '1';
                    cell.style.aspectRatio = '1';
                    cell.style.backgroundColor = 'rgba(255,255,255,0.02)';
                    cell.style.borderRadius = '2px';

                    if (count > 0) {
                        const intensity = count / maxVal;
                        cell.style.backgroundColor = `rgba(145, 103, 228, ${intensity * 0.8 + 0.2})`;
                    }

                    cell.addEventListener('mousemove', (e) => showTooltip(e, `Week ${w}, ${days[d]}: ${count} posts`));
                    cell.addEventListener('mouseleave', hideTooltip);

                    row.appendChild(cell);
                }
                gridBody.appendChild(row);
            }
            mainContainer.appendChild(gridBody);
            container.appendChild(mainContainer);
        }

        function loadWebsiteStats() {
            Promise.all([
                fetch('/analytics/data/site').then(r => r.json()),
                fetch('/analytics/data/pages').then(r => r.json())
            ]).then(([siteData, pagesData]) => {
                if (siteData) {
                    createChart('siteStatsChart', 'line', {
                        labels: siteData.map(d => d.date_str),
                        datasets: [{
                            label: 'Visitors',
                            data: siteData.map(d => d.total_visitors),
                            borderColor: colors.primary,
                            backgroundColor: 'rgba(145, 103, 228, 0.1)',
                            fill: true,
                            yAxisID: 'y'
                        }, {
                            label: 'Avg Session (s)',
                            data: siteData.map(d => d.avg_session_duration),
                            borderColor: colors.primaryLight,
                            borderDash: [5, 5],
                            yAxisID: 'y1'
                        }]
                    }, {
                        scales: {
                            y: { position: 'left', title: { display: true, text: 'Visitors' } },
                            y1: { position: 'right', title: { display: true, text: 'Seconds' }, grid: { drawOnChartArea: false } }
                        }
                    });
                }
                if (pagesData) {
                    createChart('topPagesChart', 'bar', {
                        labels: pagesData.slice(0, 15).map(d => d.url_path),
                        datasets: [{
                            label: 'Total Views',
                            data: pagesData.slice(0, 15).map(d => d.total_views),
                            backgroundColor: colors.primary
                        }]
                    }, {
                        indexAxis: 'y'
                    });
                }
            });
        }
    });
</script>

{{ template "footer.html" . }}