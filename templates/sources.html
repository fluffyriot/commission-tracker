{{ template "header.html" . }}

<div class="flex justify-between items-center mb-4">
    <div>
        <h1>Sources</h1>
    </div>

    <div class="flex gap-2">
        <form method="GET" action="/sources">
            <button class="btn btn-secondary btn-icon" title="Refresh">
                <i data-lucide="refresh-cw"></i> Refresh
            </button>
        </form>

    </div>
</div>

<div class="grid-list-sidebar">
    <div>
        <div class="card">
            <div class="card-header">Add New Source</div>
            <form method="POST" action="/sources/setup" id="source_form" autocomplete="off">
                <input type="hidden" name="user_id" value="{{.user_id}}">

                <div class="form-group">
                    <label class="form-label" for="network">Network</label>
                    <select id="network" name="network" class="form-select" required>
                        <option value="" disabled selected>Select Network</option>
                        {{range .available_sources}}
                        <option value="{{.Name}}">{{.Name}}</option>
                        {{end}}
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="username_input">Username</label>
                    <input type="text" id="username_input" name="username" class="form-input"
                        placeholder="username (no @)" required autocapitalize="off">
                </div>

                <div id="generic_fields_container">
                    <div class="form-group hidden" id="field_1_wrapper">
                        <label class="form-label" id="label_field_1" for="field_1">Field 1</label>
                        <input id="field_1" name="field_1" class="form-input" placeholder="" autocapitalize="off">
                        <p class="text-muted text-xs mt-1 hidden" id="desc_field_1"></p>
                    </div>

                    <div class="form-group hidden" id="field_2_wrapper">
                        <label class="form-label" id="label_field_2" for="field_2">Field 2</label>
                        <input id="field_2" name="field_2" class="form-input" placeholder="" autocapitalize="off">
                    </div>

                    <div class="form-group hidden" id="field_3_wrapper">
                        <label class="form-label" id="label_field_3" for="field_3">Field 3</label>
                        <input id="field_3" name="field_3" class="form-input" placeholder="" autocapitalize="off">
                        <p class="text-muted text-xs mt-1 hidden" id="desc_field_3"></p>
                    </div>

                    <div class="form-group hidden" id="field_4_wrapper">
                        <label class="form-label" id="label_field_4" for="field_4">Field 4</label>
                        <input id="field_4" name="field_4" class="form-input" placeholder="" autocapitalize="off">
                    </div>

                    <div class="form-group hidden" id="field_long_wrapper">
                        <label class="form-label" id="label_field_long" for="field_long">Service Key</label>
                        <textarea id="field_long" name="field_long" class="form-input" rows="5" placeholder=""
                            autocapitalize="off"></textarea>
                        <p class="text-muted text-xs mt-1 hidden" id="desc_field_long"></p>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary w-full">
                    <i data-lucide="plus"></i> Add Source
                </button>
            </form>
        </div>
    </div>

    <div>
        <div class="card">
            <div class="card-header">User Sources</div>

            {{if not .sources}}
            <div class="text-center p-8 text-muted">
                <i data-lucide="ghost" class="icon-xl opacity-50"></i>
                <p class="text-md">No sources connected yet.</p>
            </div>
            {{else}}
            <div class="flex flex-col gap-2">
                {{range .sources}}
                <div class="source-item">
                    <div class="source-info">
                        <div class="flex items-center gap-2">
                            <span class="badge-with-logo dynamic-badge"
                                data-bg-color="{{index $.network_colors .Network}}">
                                <img src='/static/images/sources/badge/{{replace (lower .Network) " " "_"}}_logo.svg'
                                    alt="{{.Network}}" class="badge-logo"
                                    onerror="this.style.display='none'; var ph=this.nextElementSibling; ph.style.display='flex';">
                                <div class="badge-logo-placeholder hidden">
                                    {{slice .Network 0 1 | upper}}
                                </div>
                                {{.Network}}
                            </span>
                            <span class="font-bold text-sm">{{.UserName}}</span>
                        </div>

                        <div class="source-meta flex items-center gap-2">
                            {{if .IsActive}}
                            {{if eq .SyncStatus "Synced"}}
                            <span class="badge badge-success">Synced</span>
                            {{else if eq .SyncStatus "Syncing"}}
                            <span class="badge badge-warning">Syncing</span>
                            {{else if eq .SyncStatus "Failed"}}
                            <span class="badge badge-danger">Failed</span>
                            {{else}}
                            <span class="badge badge-neutral">{{.SyncStatus}}</span>
                            {{end}}
                            {{else}}
                            <span class="badge badge-neutral">Disabled</span>
                            {{end}}

                            {{if .LastSynced.Valid}}
                            <span>last run: {{.LastSynced.Time.Format "Jan 02 15:04"}}</span>
                            {{end}}

                            {{if .StatusReason.Valid}}
                            <span title="{{.StatusReason.String}}"><i data-lucide="info" class="icon-xs"></i></span>
                            {{end}}
                        </div>
                    </div>

                    <div class="source-actions">
                        <form method="POST" action="/sources/sync" onsubmit="return submitWithConfirm(this);">
                            <input type="hidden" name="source_id" value="{{.ID}}">
                            <button type="submit" class="btn btn-secondary btn-icon" {{if not .IsActive}}disabled{{end}}
                                title="Sync Now">
                                <i data-lucide="cloud-sync"></i>
                            </button>
                        </form>

                        {{if eq .Network "TikTok"}}
                        <div class="dropdown">
                            <button type="button" class="btn btn-secondary btn-icon" title="Manage Cookies"
                                onclick="toggleDropdown('dd_{{.ID}}')">
                                <i data-lucide="key-round"></i>
                            </button>
                            <div id="dd_{{.ID}}" class="dropdown-content hidden">
                                <form method="GET" action="/sources/cookies/export">
                                    <input type="hidden" name="source_id" value="{{.ID}}">
                                    <button type="submit" class="dropdown-item">
                                        <i data-lucide="download"></i> Export Cookies
                                    </button>
                                </form>
                                <form method="POST" action="/sources/cookies/import" enctype="multipart/form-data">
                                    <input type="hidden" name="source_id" value="{{.ID}}">
                                    <input type="file" name="cookie_file" id="cookie_file_{{.ID}}" class="hidden"
                                        onchange="this.form.submit()">
                                    <button type="button" class="dropdown-item"
                                        onclick="document.getElementById('cookie_file_{{.ID}}').click()">
                                        <i data-lucide="upload"></i> Import Cookies
                                    </button>
                                </form>
                                <form method="GET" action="/auth/tiktok/login">
                                    <input type="hidden" name="username" value="{{.UserName}}">
                                    <button type="submit" class="dropdown-item text-danger">
                                        <i data-lucide="refresh-cw"></i> Renew Session
                                    </button>
                                </form>
                            </div>
                        </div>
                        {{end}}

                        {{if eq .Network "Instagram"}}
                        <form method="POST" action="/auth/facebook/refresh"
                            onsubmit="return submitWithConfirm(this, 'Refresh access token for this?');">
                            <input type="hidden" name="source_id" value="{{.ID}}">
                            <button type="submit" class="btn btn-secondary btn-icon" {{if not .IsActive}}disabled{{end}}
                                title="Refresh Token">
                                <i data-lucide="key-round"></i>
                            </button>
                        </form>
                        {{end}}

                        {{if eq .Network "Discord"}}
                        <button type="button" class="btn btn-secondary btn-icon"
                            onclick="showDiscordChannels('{{.ID}}')" title="View / Update Channels">
                            <i data-lucide="hash"></i>
                        </button>
                        {{end}}

                        {{if eq .Network "Reddit"}}
                        <button type="button" class="btn btn-secondary btn-icon"
                            onclick="showRedditSubreddits('{{.ID}}')" title="View / Update Subreddits">
                            <i data-lucide="hash"></i>
                        </button>
                        {{end}}

                        <div class="dropdown">
                            <button type="button" class="btn btn-secondary btn-icon" title="Actions"
                                onclick="toggleDropdown('dd_actions_{{.ID}}')">
                                <i data-lucide="ellipsis"></i>
                            </button>
                            <div id="dd_actions_{{.ID}}" class="dropdown-content hidden" style="min-width: 140px;">
                                {{if .IsActive}}
                                <form method="POST" action="/sources/deactivate"
                                    onsubmit="return submitWithConfirm(this, 'Deactivate this source?');">
                                    <input type="hidden" name="source_id" value="{{.ID}}">
                                    <button type="submit" class="dropdown-item" title="Disable">
                                        <i data-lucide="power"></i> Disable
                                    </button>
                                </form>
                                {{else}}
                                <form method="POST" action="/sources/activate"
                                    onsubmit="return submitWithConfirm(this);">
                                    <input type="hidden" name="source_id" value="{{.ID}}">
                                    <button type="submit" class="dropdown-item" title="Enable">
                                        <i data-lucide="power"></i> Enable
                                    </button>
                                </form>
                                {{end}}

                                <form method="POST" action="/sources/delete"
                                    onsubmit="return submitWithConfirm(this, 'Delete this source?');">
                                    <input type="hidden" name="source_id" value="{{.ID}}">
                                    <button type="submit" class="dropdown-item text-danger" title="Delete">
                                        <i data-lucide="trash-2"></i> Delete
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                {{end}}
            </div>
            {{end}}
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const networkSelect = document.getElementById("network");
        const usernameInput = document.getElementById("username_input");
        const wrappers = {
            1: document.getElementById("field_1_wrapper"),
            2: document.getElementById("field_2_wrapper"),
            3: document.getElementById("field_3_wrapper"),
            4: document.getElementById("field_4_wrapper"),
            long: document.getElementById("field_long_wrapper")
        };
        const inputs = {
            1: document.getElementById("field_1"),
            2: document.getElementById("field_2"),
            3: document.getElementById("field_3"),
            4: document.getElementById("field_4"),
            long: document.getElementById("field_long")
        };
        const labels = {
            1: document.getElementById("label_field_1"),
            2: document.getElementById("label_field_2"),
            3: document.getElementById("label_field_3"),
            4: document.getElementById("label_field_4"),
            long: document.getElementById("label_field_long")
        };
        const descs = {
            1: document.getElementById("desc_field_1"),
            3: document.getElementById("desc_field_3"),
            long: document.getElementById("desc_field_long")
        };

        const config = {
            "Instagram": {
                userPlaceholder: "username (no @)",
                fields: {
                    1: { label: "Instagram Profile ID", placeholder: "123456789", required: true },
                    2: { label: "App ID", placeholder: "Facebook App ID", required: true },
                    3: { label: "App Secret", placeholder: "Facebook App Secret", type: "password", required: true }
                }
            },
            "Google Analytics": {
                userPlaceholder: "Your website URL (e.g. https://example.com)",
                fields: {
                    1: { label: "Property ID", placeholder: "e.g. 34221144", desc: "Found in Admin > Property Settings", required: true },
                    long: { label: "Service Account JSON Key", placeholder: '{"type": "service_account", ...}', desc: "Create a Service Account in Google Cloud Console, download the JSON key, and paste it here.", required: true }
                }
            },
            "YouTube": {
                userPlaceholder: "Your Channel Handle (e.g. @username)",
                fields: {
                    long: { label: "Service Account JSON Key", placeholder: '{"type": "service_account", ...}', desc: "Create a Service Account in Google Cloud Console, download the JSON key, and paste it here.", required: true }
                }
            },
            "Telegram": {
                userPlaceholder: "username (no @)",
                fields: {
                    1: { label: "Telegram Bot Token", placeholder: "Bot Token", required: true },
                    2: { label: "Telegram Channel ID", placeholder: "Channel ID", required: true },
                    3: { label: "Telegram App ID", placeholder: "App ID", required: true },
                    4: { label: "Telegram App Hash", placeholder: "App Hash", required: true }
                }
            },
            "Discord": {
                userPlaceholder: "Discord Username",
                fields: {
                    1: { label: "Discord Bot Token", placeholder: "Bot Token", required: true },
                    2: { label: "Server ID", placeholder: "Server (Guild) ID", required: true },
                    3: { label: "Channel IDs (comma-separated)", placeholder: "123456,789012", desc: "Enter multiple channel IDs separated by commas", required: true }
                }
            },
            "e621": {
                userPlaceholder: "e621 Username (to sync)",
                fields: {
                    1: { label: "API Username", placeholder: "API username", required: true },
                    2: { label: "API Key", placeholder: "API key", required: true }
                }
            },
            "Reddit": {
                userPlaceholder: "Reddit Username (no u/)",
                fields: {
                    1: { label: "Subreddits (optional, comma-separated)", placeholder: "golang, programming", desc: "Leave empty to sync posts from all subreddits. You can change this later.", required: false }
                }
            },
            "Mastodon": {
                userPlaceholder: "username@instance.social",
                fields: {}
            },
            "Generic": {
                userPlaceholder: "Username (no @)",
                fields: {}
            }
        };


        if (!networkSelect) return;

        function updateForm() {
            const network = networkSelect.value || "Generic";
            const currentConfig = config[network] || config["Generic"];

            usernameInput.placeholder = currentConfig.userPlaceholder;

            for (const key in wrappers) {
                wrappers[key].classList.add("hidden");
                inputs[key].required = false;
                inputs[key].value = "";
                if (key !== 'long') inputs[key].type = "text";
                if (descs[key]) descs[key].classList.add("hidden");
            }

            const fields = currentConfig.fields;
            for (const key in fields) {
                const settings = fields[key];
                if (wrappers[key]) {
                    wrappers[key].classList.remove("hidden");

                    labels[key].textContent = settings.label;
                    inputs[key].placeholder = settings.placeholder;
                    inputs[key].required = settings.required;

                    if (settings.type) {
                        inputs[key].type = settings.type;
                    }

                    if (settings.desc && descs[key]) {
                        descs[key].textContent = settings.desc;
                        descs[key].classList.remove("hidden");
                    }
                }
            }
        }

        networkSelect.addEventListener("change", updateForm);
        updateForm();
    });

    const channelManagerConfigs = {
        Discord: {
            title: 'Edit Discord Channels',
            inputId: 'channel-manager-input',
            description: 'Enter channel IDs separated by commas:',
            placeholder: '123456789, 987654321, 456789123',
            note: 'Removed channels will have their posts permanently deleted on next sync.',
            requireAtLeastOne: true,
            successMessage: 'Channels updated successfully! Changes will take effect on next sync.',
        },
        Reddit: {
            title: 'Edit Subreddits',
            inputId: 'channel-manager-input',
            description: 'Enter subreddit (no r/ - just the name) names separated by commas, or leave empty to sync all posts:',
            placeholder: 'golang, programming, rust',
            note: null,
            requireAtLeastOne: false,
            successMessage: 'Subreddits updated successfully! Changes will take effect on next sync.',
        },
    };

    async function showChannelManager(sourceId, network) {
        const cfg = channelManagerConfigs[network];
        if (!cfg) return;

        try {
            const response = await fetch(`/sources/${sourceId}/channels`);
            const data = await response.json();

            if (!response.ok) {
                alert(data.error || 'Failed to fetch configuration');
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'modal-overlay';

            const content = document.createElement('div');
            content.className = 'modal-content';

            const header = document.createElement('div');
            header.className = 'modal-header';
            const titleEl = document.createElement('h3');
            titleEl.textContent = cfg.title;
            const closeBtn = document.createElement('button');
            closeBtn.className = 'modal-close-btn';
            closeBtn.title = 'Close';
            closeBtn.textContent = 'Ã—';
            closeBtn.onclick = () => modal.remove();
            header.appendChild(titleEl);
            header.appendChild(closeBtn);

            const body = document.createElement('div');
            body.className = 'modal-body';
            const desc = document.createElement('p');
            desc.className = 'modal-text-muted';
            desc.textContent = cfg.description;
            const textarea = document.createElement('textarea');
            textarea.id = cfg.inputId;
            textarea.className = 'form-input modal-textarea';
            textarea.placeholder = cfg.placeholder;
            textarea.value = data.channels.join(', ');
            body.appendChild(desc);
            body.appendChild(textarea);
            if (cfg.note) {
                const noteBox = document.createElement('div');
                noteBox.className = 'modal-info-box';
                const noteP = document.createElement('p');
                const strong = document.createElement('strong');
                strong.textContent = 'Note: ';
                noteP.appendChild(strong);
                noteP.appendChild(document.createTextNode(cfg.note));
                noteBox.appendChild(noteP);
                body.appendChild(noteBox);
            }

            const footer = document.createElement('div');
            footer.className = 'modal-footer';
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'btn btn-secondary';
            cancelBtn.textContent = 'Cancel';
            cancelBtn.onclick = () => modal.remove();
            const saveBtn = document.createElement('button');
            saveBtn.className = 'btn btn-primary';
            saveBtn.textContent = 'Save Changes';
            saveBtn.onclick = () => saveChannelManager(sourceId, network);
            footer.appendChild(cancelBtn);
            footer.appendChild(saveBtn);

            content.appendChild(header);
            content.appendChild(body);
            content.appendChild(footer);
            modal.appendChild(content);
            document.body.appendChild(modal);
            modal.style.display = 'flex';

            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            textarea.focus();
        } catch (error) {
            console.error('Error fetching channel configuration:', error);
            alert('Failed to fetch configuration');
        }
    }

    async function saveChannelManager(sourceId, network) {
        const cfg = channelManagerConfigs[network];
        if (!cfg) return;

        const input = document.getElementById(cfg.inputId);
        const channels = input.value
            .split(',')
            .map(s => s.trim())
            .filter(s => s.length > 0);

        if (cfg.requireAtLeastOne && channels.length === 0) {
            alert('Please enter at least one value');
            return;
        }

        try {
            const response = await fetch(`/sources/${sourceId}/channels`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ channels }),
            });

            const data = await response.json();

            if (response.ok) {
                alert(cfg.successMessage);
                document.querySelector('.modal-overlay').remove();
                location.reload();
            } else {
                alert(data.error || 'Failed to update');
            }
        } catch (error) {
            console.error('Error saving channel configuration:', error);
            alert('Failed to update');
        }
    }

    function showDiscordChannels(sourceId) { showChannelManager(sourceId, 'Discord'); }
    function showRedditSubreddits(sourceId) { showChannelManager(sourceId, 'Reddit'); }


</script>

{{ template "footer.html" . }}